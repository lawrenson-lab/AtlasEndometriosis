---
title: "Extended Figure 1"
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "docs") })
---


```{r include = FALSE}
rm(list = ls())

library(ComplexHeatmap)
library(circlize)
library(Seurat)
library(ggplot2)
library(dplyr)
library(plotly)
library(cowplot)
library(tidyr)
library(corrplot)
library('org.Hs.eg.db')
library(ReactomePA)
library("AnnotationDbi")
library("clusterProfiler")
library(Seurat)
library(SeuratDisk)

```

Load cohort information and Seurat object containing all identified cell types. 

```{r include = F, eval=T, message=F, warning=F}

anno <- read.table("files/Endometriosis single cell cohort - Cohort.updated.Jan.06.2022.csv", sep = ",", header = TRUE, stringsAsFactors = F)
anno = anno[!anno$Status == "Fail", 1:21]
anno$Major.Class[anno$Major.Class == "Extra-ovarian endometriosis"] <- "Endometriosis"
.anno = anno[!anno$Patient.No. == "",]
.anno$SampleName[33:49] <- paste0(.anno$SampleName[33:49], "_", .anno$Index[33:49])
.anno = .anno[1:49,]
rownames(.anno) <- .anno$SampleName
.anno$Major.Class[.anno$SampleName == "BEME228_A4"] <- "Endometriosis"
.anno
dim(.anno)

aux.seurat <- readRDS("rds/aux.seurat.rds")

```

## Figure 2-A

```{r include = T, eval=T, fig.align = 'center', fig.height=4, fig.width=13}

p4 = DimPlot(aux.seurat, 
             reduction = "umap", 
             raster=FALSE, 
             group.by = "Major.Class", 
             pt.size = .1, 
             split.by = 'Major.Class', 
             cols = c("Endometrioma" = "#7b3294", 
                      "Eutopic Endometrium" = "#c2a5cf", 
                      "Endometriosis" = "#d9f0d3", 
                      "No endometriosis detected" = "#a6dba0",
                      "Unaffected ovary" = "#008837"))

p4
```

## Figure 2-B

```{r include = T, eval=T, fig.align = 'center', fig.width=12, fig.height=8}

p4 = DimPlot(object = aux.seurat, 
             pt.size = 0.1, 
             raster=FALSE, 
             label = T)
p4

```

## Figure 2-C

```{r include = T, eval=T, fig.align = 'center', fig.height=6, fig.width=8}

p4 = DimPlot(object = aux.seurat, 
             pt.size = 0.1, 
             raster=FALSE, 
             group.by = "active.cluster",
             label = T)
p4
print(table(aux.seurat@meta.data$Major.Class))
```


## Figure 3-E

```{r include = T, eval=T, fig.width = 10, fig.asp = .62, message=F, warning=FALSE}
table.gene.markers <- data.frame(Gene=c("DCN", "COL11A1", "PDGFRA","PDGFRB"), Cell="Mesenchymal cells")
table.gene.markers <- rbind(table.gene.markers, data.frame(Gene=c("EPCAM", "KRT8", "KRT10", "KRT18", "KRT19"), Cell="Epithelial cells"))
table.gene.markers <- rbind(table.gene.markers, data.frame(Gene=c("ACTA2"), Cell="Smooth muscle cells"))
table.gene.markers <- rbind(table.gene.markers, data.frame(Gene=c("HBB", "GYPA"), Cell="Erythrocytes")) 
table.gene.markers <- rbind(table.gene.markers, data.frame(Gene=c("CLDN5", "PECAM1", "CD34", "ESAM"), Cell="Endothelial cells"))
table.gene.markers <- rbind(table.gene.markers, data.frame(Gene=c("TPSB2"), Cell="Mast cells"))
table.gene.markers <- rbind(table.gene.markers, data.frame(Gene=c("LYZ", "CD14","C1QA", "CLEC10A"), Cell="Myeloid cells"))
table.gene.markers <- rbind(table.gene.markers, data.frame(Gene=c("CD2", "CD3D", "CD3E", "CD3G", 'CD8A', "CCL5"), Cell="T/NK cells"))
table.gene.markers <- rbind(table.gene.markers, data.frame(Gene=c("JCHAIN", "CD79A"), Cell="B/Plasma cells"))

p = DotPlot(object = aux.seurat, assay = "RNA", group.by = "active.cluster", features = table.gene.markers$Gene) +
        scale_colour_gradient2(low = "#2166ac", mid = "#f7f7f7", high = "#b2182b") +
        RotatedAxis()
p

```

## Figure 3-F

```{r include = T, eval=T, fig.align = 'center', warning=F, message=F}

bsize = 14
aux = data.frame(table(aux.seurat@meta.data$active.cluster))
aux = aux[order(aux$Freq),]
aux$Var1 <- factor(aux$Var1, levels = aux$Var1)
order.cell = aux$Var1

pd <- ggplot(aux, aes(x = Var1, y = Freq)) +
        geom_point(size=2) +
        theme_minimal(base_size = bsize) +
        ylim(0, 77000) +
        scale_y_continuous(breaks=c(0, 25000, 50000, 75000, 100000, 125000)) +
        geom_hline(yintercept = c(0, 25000, 50000, 75000, 100000, 125000), linetype="dashed", color = "grey") +
        coord_flip() +
        theme(plot.title = element_text(hjust = 0.5),
              axis.text.x = element_text(angle = 270, hjust = 1),
              axis.title.x = element_blank(),
              axis.title.y = element_blank(),
              legend.position = "left")
pd
              
counts.prop = data.frame(table(aux.seurat@meta.data$Major.Class, aux.seurat@meta.data$active.cluster))
counts.prop.perc = group_by(counts.prop, Var2) %>% mutate(percent = Freq/sum(Freq))

aux = aggregate(counts.prop$Freq, by=list(Category=counts.prop$Var1), FUN=sum)
aux$Var2 = "Total"
colnames(aux) <- c("Var1", "Freq", "Var2")
aux$Var2 <- factor(aux$Var2, levels = c("Total", order.cell))

aux$percent = aux$Freq / sum(aux$Freq)
counts.prop.perc = rbind(as.data.frame(counts.prop.perc), aux)

pd <- ggplot(counts.prop.perc, aes(x = Var2, y = percent, fill = Var1, group=Var2)) + 
        geom_bar(position="stack",stat = "identity", width=0.8) +
        scale_fill_manual(name="Class", values = c("Endometrioma" = "#7b3294", 
                                                   "Eutopic Endometrium" = "#c2a5cf", 
                                                   "Endometriosis" = "#d9f0d3", 
                                                   "No endometriosis detected" = "#a6dba0",
                                                   "Unaffected ovary" = "#008837")) +
        coord_flip() +
        theme_set(theme_gray(base_size = bsize)) +
        theme(plot.title = element_text(hjust = 0.5),
              axis.text.x = element_text(angle = 270, hjust = 1),
              axis.text.y = element_text(angle = 0, hjust = 1),
              axis.title.x = element_blank(),
              axis.title.y = element_blank(),
              legend.position = "none")
pd

```

```{r include = T, eval=T, fig.align = 'center'}

counts.prop = data.frame(table(aux.seurat@meta.data$Patient.No., aux.seurat@meta.data$active.cluster))
counts.prop.perc = group_by(counts.prop, Var2) %>% mutate(percent = Freq/sum(Freq))

col = c("#a50026", "#d73027", "#f46d43", "#fdae61", "#fee090", "#ffffbf",
        "#00441b", "#1b7837", "#5aae61", "#a6dba0", "#d9f0d3", "#f7f7f7",
        "#e0f3f8", "#abd9e9", "#74add1", "#4575b4", "#313695",
        "#40004b","#762a83", "#9970ab", "#c2a5cf")

aux = aggregate(counts.prop$Freq, by=list(Category=counts.prop$Var1), FUN=sum)
aux$Var2 = "Total"
colnames(aux) <- c("Var1", "Freq", "Var2")
aux$Var2 <- factor(aux$Var2, levels = c("Total", order.cell))
aux$percent = aux$Freq / sum(aux$Freq)
counts.prop.perc = rbind(as.data.frame(counts.prop.perc), aux)

p1 <- ggplot(counts.prop.perc, aes(x = Var2, y = percent, fill = Var1, group=Var2)) + 
        geom_bar(position="stack",stat = "identity", width=0.8) +
        scale_fill_manual(name="Patient", values = c(  "1" = col[1],
                                                       "2" = col[2],
                                                       "3" = col[3],
                                                       "4" = col[4],
                                                       "5" = col[5],
                                                       "6" = col[6],
                                                       "7" = col[7],
                                                       "8" = col[8],
                                                       "9"= col[9],
                                                       "10" = col[10],
                                                       "11"= col[11],
                                                       "12" = col[12],
                                                       "13" = col[13],
                                                       "14" = col[14],
                                                       "15" = col[15],
                                                       "16" = col[16],
                                                       "17" = col[17],
                                                       "18" = col[18],
                                                       "19" = col[19],
                                                       "20"= col[20],
                                                       "21" = col[21])) +
        coord_flip() +
        theme_set(theme_gray(base_size = bsize)) +
        theme(plot.title = element_text(hjust = 0.5),
              axis.text.x = element_text(angle = 270, hjust = 1),
              axis.text.y = element_text(angle = 0, hjust = 1),
              axis.title.x = element_blank(),
              axis.title.y = element_blank(),
              legend.position = "none")
p1

```









